<!DOCTYPE html>
<html>
    <head>
        <title>Wavetable spicer</title>
        <meta charset="UTF-8"/>
        <link rel="preload" href="ONESIZE_.TTF" as="font" crossorigin="anonymous"/>
        <link rel="preload" href="ONESR___.TTF" as="font" crossorigin="anonymous"/>
        <link rel="preload" href="PressStart2P-Regular.ttf" as="font" crossorigin="anonymous"/>
        <link rel="preload" href="light_pixel-7.ttf" as="font" crossorigin="anonymous"/>
        <link rel="stylesheet" href="bit.css"/>
        <style>
            input[type="text"], textarea {
                height: 16px;
                border: 2px solid black;
                vertical-align: bottom;
                font-family: pressstart2p;
                font-size: 16px;
                width: calc(100% - 16px);
            }
            input[type="text"]:focus, textarea:focus {outline: 2px solid white;}
            input[type="text"]::selection, textarea::selection {background: black; color: white;}
            textarea {resize: none; height: 128px;}
        </style>
    </head>
    <body>
        <dither style="width:436px;"></dither>
        <h1>Wavetable spicer</h1>
        <dither style="width:436px;"></dither>
        
        <div class="paragraph">Make your N163 wavetable more interesting.</div>
        <div>Wavetable: <input type="text" value="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 15 15 15 15 15 15 15 15 15 15 15 15" class="wave"/></div>
        <div class="paragraph">Output:<br/><textarea class="textarea" readonly ></textarea></div>
        <br/>
        <canvas class="canvas" height="32" width="256"></canvas>
        
        <script>
            let waveel = document.querySelector(".wave");
            waveel.onchange = function(e) {generate(waveel.value);};
            let textarea = document.querySelector(".textarea");
            textarea.onclick = function(e) {textarea.select();document.execCommand('copy');};
            function generate(wavedata) {
                // setup //
                var wave = wavedata.split(" ").map(x=>parseInt(x));
                var wavetable = "";            // wavetable string
                const depth = 16;              // depth
                const length = wave.length;
                for (var p=0;p<length;p++) {
                    // calculate //
                    for (var i=0;i<length;i++) {
                        let x = i;
                        let x_p = (i+p)%length;
                        let output = Math.floor(wave[x]*0.75+wave[x_p]*0.25);
                        // add sample //
                        wavetable += Math.floor(output)+" ";
                    }
                    // add newline //
                    wavetable += ";\n";
                }
                textarea.value = wavetable;
                return wavetable;
            }
            generate(waveel.value);
            let canvas = document.querySelector(".canvas");
            let ctx = canvas.getContext("2d");
            let phase = 0;
            function draw() {
                let wavetables = textarea.value.split(" ;\n");
                let wavetable = wavetables[phase].split(" ").map(x=>parseInt(x));
                ctx.fillStyle = "#000000";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = "#FFFFFF";
                for (var i=0;i<wavetable.length;i++) {
                    ctx.fillRect(i*2, canvas.height-wavetable[i]*2-2, 2, 2);
                }
                phase = phase+1;
                while (phase >= wavetables.length-1) {phase -= wavetables.length-1;}
                window.requestAnimationFrame(draw);
            }
            window.requestAnimationFrame(draw);
        </script>
    </body>
</html>
